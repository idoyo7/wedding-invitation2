name: Build and Push Docker Image (No Cache)

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  # Docker Hub
  IMAGE_NAME: montkim9/invi2

  # montstrap repo / path
  MONTSTRAP_REPO: idoyo7/montstrap-manifest
  MONTSTRAP_FILE: deployment.yaml

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      packages: write

    outputs:
      short_sha: ${{ steps.vars.outputs.short_sha }}
      # NOTE: image_tag output sometimes resolves empty in downstream jobs.
      # Derive it from short_sha to make it deterministic.
      image_tag: ${{ format('montkim9/invi2:{0}', steps.vars.outputs.short_sha) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract short SHA
        id: vars
        run: |
          set -euo pipefail

          SHORT_SHA="$(printf "%s" "${GITHUB_SHA}" | cut -c1-6)"
          if [ -z "${SHORT_SHA}" ]; then
            echo "âŒ SHORT_SHA is empty (GITHUB_SHA='${GITHUB_SHA:-}')" >&2
            exit 1
          fi

          IMAGE_TAG="${{ env.IMAGE_NAME }}:${SHORT_SHA}"
          if [ -z "${IMAGE_TAG}" ]; then
            echo "âŒ IMAGE_TAG is empty" >&2
            exit 1
          fi

          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "image_tag=${IMAGE_TAG}" >> "$GITHUB_OUTPUT"
          echo "âœ… Computed SHORT_SHA=${SHORT_SHA}"
          echo "âœ… Computed IMAGE_TAG=${IMAGE_TAG}"

      - name: Debug step outputs
        run: |
          echo "steps.vars.outputs.short_sha='${{ steps.vars.outputs.short_sha }}'"
          echo "steps.vars.outputs.image_tag='${{ steps.vars.outputs.image_tag }}'"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Push ë˜ëŠ” ì¼€ì´ìŠ¤ (push to main/master or workflow_dispatch ë“±)
      - name: Build and push Docker image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          # cache ë„ê³  ì‹¶ìœ¼ë©´ ì•„ëž˜ ë‘ ì¤„ ì¶”ê°€
          # no-cache: true
          # pull: true
          build-args: |
            NEXT_PUBLIC_NAVER_MAP_CLIENT_ID=${{ secrets.NEXT_PUBLIC_NAVER_MAP_CLIENT_ID }}
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}
            ${{ env.IMAGE_NAME }}:latest

      # PRì€ push ì—†ì´ buildë§Œ
      - name: Build Docker image (Pull Request)
        if: github.event_name == 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: false
          build-args: |
            NEXT_PUBLIC_NAVER_MAP_CLIENT_ID=test_key_for_pr
          tags: |
            ${{ env.IMAGE_NAME }}:pr-${{ github.event.pull_request.number }}
      - name: Build Summary
        if: always()
        run: |
          echo "### ðŸ“¦ Wedding Invitation Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Ref:** \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**SHA:** \`${{ steps.vars.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** \`linux/amd64\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**Image Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
            echo "${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          else
            echo "${{ env.IMAGE_NAME }}:pr-${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY

  update-manifests:
    name: Update montstrap deployment manifest
    needs: build-and-push
    runs-on: ubuntu-latest

    # main/master pushì—ì„œë§Œ ì‹¤í–‰
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    permissions:
      contents: write

    env:
      SHORT_SHA: ${{ needs.build-and-push.outputs.short_sha }}
      # Don't rely on needs.*.outputs.image_tag (it may be empty); compute from SHORT_SHA.
      IMAGE_TAG: ${{ format('montkim9/invi2:{0}', needs.build-and-push.outputs.short_sha) }}

    steps:
      - name: Validate computed image tag (fail fast)
        run: |
          set -euo pipefail
          echo "SHORT_SHA='${SHORT_SHA}'"
          echo "IMAGE_TAG='${IMAGE_TAG}'"

          if [ -z "${IMAGE_TAG}" ]; then
            echo "âŒ IMAGE_TAG is empty. Refusing to modify manifest." >&2
            exit 1
          fi

          case "${IMAGE_TAG}" in
            "${{ env.IMAGE_NAME }}:"*) ;;
            *)
              echo "âŒ IMAGE_TAG does not match expected prefix '${{ env.IMAGE_NAME }}:'" >&2
              exit 1
              ;;
          esac

      - name: Checkout montstrap repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.MONTSTRAP_REPO }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: montstrap

      - name: Verify montstrap checkout
        run: |
          echo "--- Verifying montstrap repository checkout ---"
          echo "Repository: ${{ env.MONTSTRAP_REPO }}"
          echo "SHORT_SHA: ${SHORT_SHA}"
          echo "IMAGE_TAG: ${IMAGE_TAG}"
          echo ""
          ls -la montstrap/

      - name: Update manifests for both apps
        id: update_manifests
        run: |
          set -euo pipefail
          cd montstrap

          MANIFEST_DIRS=("wedding-app/manifests" "wedding-app-external/manifests")
          CHANGES_MADE=false
          
          for MANIFEST_DIR in "${MANIFEST_DIRS[@]}"; do
            MANIFEST_FILE="${MANIFEST_DIR}/${{ env.MONTSTRAP_FILE }}"
            
            echo "--- Processing ${MANIFEST_FILE} ---"
            
            if [ ! -f "${MANIFEST_FILE}" ]; then
              echo "âŒ Manifest not found: ${MANIFEST_FILE}"
              continue
            fi

            echo "--- Before ---"
            grep -n "image:" "${MANIFEST_FILE}" || true

            if [ -z "${IMAGE_TAG}" ]; then
              echo "âŒ IMAGE_TAG is empty. Refusing to run sed replacement." >&2
              exit 1
            fi

            # Update image tag
            if grep -Eq "^[[:space:]]*image:[[:space:]]*${{ env.IMAGE_NAME }}:" "${MANIFEST_FILE}"; then
              sed -i -E "s|(^[[:space:]]*image:[[:space:]]*)${{ env.IMAGE_NAME }}:.*|\\1${IMAGE_TAG}|g" "${MANIFEST_FILE}"
              CHANGES_MADE=true
            else
              echo "âš ï¸ No matching image line for ${{ env.IMAGE_NAME }} found in ${MANIFEST_FILE}"
            fi

            echo "--- After ---"
            grep -n "image:" "${MANIFEST_FILE}" || true
          done
          
          echo "changes_made=${CHANGES_MADE}" >> "$GITHUB_OUTPUT"


      - name: Commit and push changes to montstrap
        if: steps.update_manifests.outputs.changes_made == 'true'
        run: |
          set -euo pipefail
          cd montstrap

          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          git status
          git add wedding-app/manifests/${{ env.MONTSTRAP_FILE }} wedding-app-external/manifests/${{ env.MONTSTRAP_FILE }}
          git commit -m "ðŸš€ Update invi2 image tag to ${SHORT_SHA} for both apps"

          # main/master ì–´ëŠ ë¸Œëžœì¹˜ì¸ì§€ ìžë™ìœ¼ë¡œ ë§žì¶° í‘¸ì‹œ
          BRANCH="${GITHUB_REF_NAME}"
          echo "Pushing to branch: ${BRANCH}"
          git push origin "${BRANCH}"

      - name: Update Summary
        if: always()
        run: |
          echo "### ðŸš€ Deployment Manifest Update Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repo:** \`${{ env.MONTSTRAP_REPO }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Files:** \`wedding-app/manifests/${{ env.MONTSTRAP_FILE }}\`, \`wedding-app-external/manifests/${{ env.MONTSTRAP_FILE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.update_manifests.outputs.changes_made || 'false' }}" = "true" ]; then
            echo "âœ… Updated and pushed successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes were needed (or update step did not run)." >> $GITHUB_STEP_SUMMARY
          fi

  deploy-ready:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    needs: [build-and-push, update-manifests]
    runs-on: ubuntu-latest
    steps:
      - name: Deploy notification
        run: |
          SHORT_SHA="${{ needs.build-and-push.outputs.short_sha }}"
          IMAGE_TAG="${{ needs.build-and-push.outputs.image_tag }}"

          echo "### ðŸŽ‰ Wedding Invitation - Deployment Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Docker image built/pushed and manifest updated." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${IMAGE_TAG}\` (and \`${{ env.IMAGE_NAME }}:latest\`)" >> $GITHUB_STEP_SUMMARY
          echo "**Manifests:** \`${{ env.MONTSTRAP_REPO }}/wedding-app/manifests/${{ env.MONTSTRAP_FILE }}\`, \`${{ env.MONTSTRAP_REPO }}/wedding-app-external/manifests/${{ env.MONTSTRAP_FILE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**SHA:** \`${SHORT_SHA}\`" >> $GITHUB_STEP_SUMMARY

  failure-notification:
    if: failure()
    needs: [build-and-push, update-manifests]
    runs-on: ubuntu-latest
    steps:
      - name: Send Failure Notification
        run: |
          echo "### âŒ CI/CD Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${GITHUB_SHA::8}\`" >> $GITHUB_STEP_SUMMARY
