name: Build and Push Docker Image (No Cache)

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  # Docker Hub
  IMAGE_NAME: montkim9/wedding-invitation

  # montstrap repo / path
  MONTSTRAP_REPO: idoyo7/montstrap
  MONTSTRAP_DIR: wedding-invitation/manifests
  MONTSTRAP_FILE: deployment.yaml

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      packages: write

    outputs:
      short_sha: ${{ steps.vars.outputs.short_sha }}
      image_tag: ${{ steps.vars.outputs.image_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract short SHA
        id: vars
        run: |
          SHORT_SHA="${GITHUB_SHA::6}"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "image_tag=${{ env.IMAGE_NAME }}:${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Push ë˜ëŠ” ì¼€ì´ìŠ¤ (push to main/master or workflow_dispatch ë“±)
      - name: Build and push Docker image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          # cache ë„ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ë‘ ì¤„ ì¶”ê°€
          # no-cache: true
          # pull: true
          build-args: |
            NEXT_PUBLIC_NAVER_MAP_CLIENT_ID=${{ secrets.NEXT_PUBLIC_NAVER_MAP_CLIENT_ID }}
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}
            ${{ env.IMAGE_NAME }}:latest

      # PRì€ push ì—†ì´ buildë§Œ
      - name: Build Docker image (Pull Request)
        if: github.event_name == 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: false
          build-args: |
            NEXT_PUBLIC_NAVER_MAP_CLIENT_ID=test_key_for_pr
          tags: |
            ${{ env.IMAGE_NAME }}:pr-${{ github.event.pull_request.number }}
      - name: Build Summary
        if: always()
        run: |
          echo "### ğŸ“¦ Wedding Invitation Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Ref:** \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**SHA:** \`${{ steps.vars.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** \`linux/amd64\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**Image Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
            echo "${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          else
            echo "${{ env.IMAGE_NAME }}:pr-${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY

  update-manifests:
    name: Update montstrap deployment manifest
    needs: build-and-push
    runs-on: ubuntu-latest

    # main/master pushì—ì„œë§Œ ì‹¤í–‰
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    permissions:
      contents: write

    env:
      SHORT_SHA: ${{ needs.build-and-push.outputs.short_sha }}
      IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}

    steps:
    - name: Checkout montstrap repository
      uses: actions/checkout@v4
      with:
        repository: ${{ env.MONTSTRAP_REPO }}
        token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
        path: montstrap

    - name: Verify montstrap checkout
      run: |
        echo "--- Verifying montstrap repository checkout ---"
        echo "Repository: ${{ env.MONTSTRAP_REPO }}"
        echo "SHORT_SHA: ${SHORT_SHA}"
        echo "IMAGE_TAG: ${IMAGE_TAG}"
        echo ""
        ls -la montstrap/

    - name: Ensure manifest exists
      id: ensure
      run: |
          set -euo pipefail
          cd montstrap

          MANIFEST_DIR="${{ env.MONTSTRAP_DIR }}"
          MANIFEST_FILE="${MANIFEST_DIR}/${{ env.MONTSTRAP_FILE }}"

          mkdir -p "${MANIFEST_DIR}"

          if [ ! -f "${MANIFEST_FILE}" ]; then
            echo "Manifest not found. Creating: ${MANIFEST_FILE}"
            echo "apiVersion: apps/v1" > "${MANIFEST_FILE}"
            echo "kind: Deployment" >> "${MANIFEST_FILE}"
            echo "metadata:" >> "${MANIFEST_FILE}"
            echo "  name: wedding-invitation" >> "${MANIFEST_FILE}"
            echo "  namespace: wedding-invitation" >> "${MANIFEST_FILE}"
            echo "  labels:" >> "${MANIFEST_FILE}"
            echo "    app: wedding-invitation" >> "${MANIFEST_FILE}"
            echo "spec:" >> "${MANIFEST_FILE}"
            echo "  replicas: 2" >> "${MANIFEST_FILE}"
            echo "  revisionHistoryLimit: 2" >> "${MANIFEST_FILE}"
            echo "  selector:" >> "${MANIFEST_FILE}"
            echo "    matchLabels:" >> "${MANIFEST_FILE}"
            echo "      app: wedding-invitation" >> "${MANIFEST_FILE}"
            echo "  template:" >> "${MANIFEST_FILE}"
            echo "    metadata:" >> "${MANIFEST_FILE}"
            echo "      labels:" >> "${MANIFEST_FILE}"
            echo "        app: wedding-invitation" >> "${MANIFEST_FILE}"
            echo "    spec:" >> "${MANIFEST_FILE}"
            echo "      containers:" >> "${MANIFEST_FILE}"
            echo "        - name: wedding-invitation" >> "${MANIFEST_FILE}"
            echo "          image: ${IMAGE_TAG}" >> "${MANIFEST_FILE}"
            echo "          ports:" >> "${MANIFEST_FILE}"
            echo "            - containerPort: 3000" >> "${MANIFEST_FILE}"
          fi

          echo "manifest_file=${MANIFEST_FILE}" >> "$GITHUB_OUTPUT"
          echo "--- Current image lines ---"
          grep -n "image:" "${MANIFEST_FILE}" || true

    - name: Update image tag in manifest
      id: update
      run: |
          set -euo pipefail
          cd montstrap

          MANIFEST_FILE="${{ steps.ensure.outputs.manifest_file }}"

          echo "--- Before ---"
          grep -n "image:" "${MANIFEST_FILE}" || true

          # ê³µë°±/ë“¤ì—¬ì“°ê¸° í¬í•¨í•´ image ë¼ì¸ì„ ì•ˆì „í•˜ê²Œ êµì²´
          # 1) image: <IMAGE_NAME>:<anything> í˜•íƒœê°€ ìˆìœ¼ë©´ êµì²´
          if grep -Eq "^[[:space:]]*image:[[:space:]]*${{ env.IMAGE_NAME }}:" "${MANIFEST_FILE}"; then
            sed -i -E "s|(^[[:space:]]*image:[[:space:]]*)${{ env.IMAGE_NAME }}:.*|\1${IMAGE_TAG}|g" "${MANIFEST_FILE}"
          else
            # 2) image: ë¼ì¸ì´ ì•„ì˜ˆ ì—†ê±°ë‚˜ ë‹¤ë¥¸ ì´ë¯¸ì§€ë©´, ì²« ë²ˆì§¸ ì»¨í…Œì´ë„ˆ ë¸”ë¡ ì•„ë˜ì— ë„£ê³  ì‹¶ë‹¤ë©´ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
            #    ì—¬ê¸°ì„œëŠ” "image:" ë¼ì¸ì´ ìˆìœ¼ë©´ ê·¸ê±¸ êµì²´(ì´ë¯¸ì§€ëª…ì´ ë‹¤ë¥´ë©´ ë°”ê¾¸ì§€ ì•ŠìŒ)í•˜ê³ ,
            #    ì—†ìœ¼ë©´ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•´ì„œ ëˆˆì— ë„ê²Œ í•¨.
            echo "âŒ No matching image line for ${{ env.IMAGE_NAME }} found in ${MANIFEST_FILE}"
            echo "Please ensure the manifest contains an image line for ${{ env.IMAGE_NAME }}."
            echo "--- Full manifest ---"
            cat "${MANIFEST_FILE}"
            exit 1
          fi

          echo "--- After ---"
          grep -n "image:" "${MANIFEST_FILE}" || true

          # ë³€ê²½ ì—¬ë¶€ ì²´í¬
          if git diff --exit-code --quiet "${MANIFEST_FILE}"; then
            echo "changes_made=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected."
          else
            echo "changes_made=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected."
          fi

    - name: Commit and push changes to montstrap
      if: steps.update.outputs.changes_made == 'true'
      run: |
          set -euo pipefail
          cd montstrap

          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          git status
          git add "${{ steps.ensure.outputs.manifest_file }}"
          git commit -m "ğŸš€ Update wedding-invitation image tag to ${SHORT_SHA}"

          # main/master ì–´ëŠ ë¸Œëœì¹˜ì¸ì§€ ìë™ìœ¼ë¡œ ë§ì¶° í‘¸ì‹œ
          BRANCH="${GITHUB_REF_NAME}"
          echo "Pushing to branch: ${BRANCH}"
          git push origin "${BRANCH}"

    - name: Update Summary
      if: always()
      run: |
          echo "### ğŸš€ Deployment Manifest Update Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repo:** \`${{ env.MONTSTRAP_REPO }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**File:** \`${{ env.MONTSTRAP_DIR }}/${{ env.MONTSTRAP_FILE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.update.outputs.changes_made || 'false' }}" = "true" ]; then
            echo "âœ… Updated and pushed successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes were needed (or update step did not run)." >> $GITHUB_STEP_SUMMARY
          fi

  deploy-ready:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    needs: [build-and-push, update-manifests]
    runs-on: ubuntu-latest
    steps:
    - name: Deploy notification
      run: |
          SHORT_SHA="${{ needs.build-and-push.outputs.short_sha }}"
          IMAGE_TAG="${{ needs.build-and-push.outputs.image_tag }}"

          echo "### ğŸ‰ Wedding Invitation - Deployment Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Docker image built/pushed and manifest updated." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${IMAGE_TAG}\` (and \`${{ env.IMAGE_NAME }}:latest\`)" >> $GITHUB_STEP_SUMMARY
          echo "**Manifest:** \`${{ env.MONTSTRAP_REPO }}/${{ env.MONTSTRAP_DIR }}/${{ env.MONTSTRAP_FILE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**SHA:** \`${SHORT_SHA}\`" >> $GITHUB_STEP_SUMMARY

  failure-notification:
    if: failure()
    needs: [build-and-push, update-manifests]
    runs-on: ubuntu-latest
    steps:
    - name: Send Failure Notification
      run: |
          echo "### âŒ CI/CD Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${GITHUB_SHA::8}\`" >> $GITHUB_STEP_SUMMARY
