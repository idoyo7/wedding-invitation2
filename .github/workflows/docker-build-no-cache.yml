name: Build and Push Docker Image (No Cache)

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©

env:
  # Docker Hub (ê¸°ë³¸ registry)
  IMAGE_NAME: montkim9/wedding-invitation
  # montstrap ë ˆí¬ì§€í† ë¦¬ ê²½ë¡œ
  MONTSTRAP_REPO: idoyo7/montstrap
  MONTSTRAP_PATH: montstrap/wedding-invitation/manifests/deployment.yaml

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: write # montstrap ë ˆí¬ì§€í† ë¦¬ì— í‘¸ì‹œí•˜ê¸° ìœ„í•´ í•„ìš”
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract short SHA
      id: vars
      run: echo "SHORT_SHA=${GITHUB_SHA:0:6}" >> $GITHUB_ENV

    - name: Log in to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      if: github.event_name != 'pull_request'
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        build-args: |
          NEXT_PUBLIC_NAVER_MAP_CLIENT_ID=${{ secrets.NEXT_PUBLIC_NAVER_MAP_CLIENT_ID }}
        tags: |
          ${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}
          ${{ env.IMAGE_NAME }}:latest
        
    - name: Build Docker image (Pull Request)
      if: github.event_name == 'pull_request'
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: false
        build-args: |
          NEXT_PUBLIC_NAVER_MAP_CLIENT_ID=test_key_for_pr

    - name: Build Summary
      if: always() # í•­ìƒ ì‹¤í–‰
      run: |
        echo "### ðŸ“¦ Wedding Invitation Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image Tags:**" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event_name }}" != "pull_request" ]; then
          echo "${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "${{ env.IMAGE_NAME }}:pr-${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Registry:** \`Docker Hub\`" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**SHA:** \`${{ env.SHORT_SHA }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Platform:** \`linux/amd64\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

  # montstrap ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  update-manifests:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout montstrap repository
      uses: actions/checkout@v4
      with:
        repository: ${{ env.MONTSTRAP_REPO }}
        token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
        path: montstrap
        
    - name: Verify montstrap checkout
      run: |
        echo "--- Verifying montstrap repository checkout ---"
        echo "Repository: ${{ env.MONTSTRAP_REPO }}"
        echo "Target path: ${{ env.MONTSTRAP_PATH }}"
        echo ""
        echo "Checking montstrap directory structure:"
        ls -la montstrap/ || echo "âŒ montstrap directory not found"
        echo ""
        echo "Checking if wedding-invitation directory exists:"
        ls -la montstrap/wedding-invitation/ || echo "âŒ wedding-invitation directory not found (will be created)"
        echo ""

    - name: Update deployment manifest
      id: update-manifest
      run: |
        echo "--- Updating Deployment Manifest ---"
        cd montstrap
        
        # ëŒ€ìƒ ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ê²½ë¡œ
        MANIFEST_DIR="wedding-invitation/manifests"
        MANIFEST_FILE="${MANIFEST_DIR}/deployment.yaml"

        echo "Checking for directory: ${MANIFEST_DIR}"
        if [ ! -d "${MANIFEST_DIR}" ]; then
          echo "Directory ${MANIFEST_DIR} not found. Creating it..."
          mkdir -p "${MANIFEST_DIR}"
          echo "Directory created: ${MANIFEST_DIR}"
        fi

        echo "Checking for file: ${MANIFEST_FILE}"
        if [ ! -f "${MANIFEST_FILE}" ]; then
          echo "File ${MANIFEST_FILE} not found. Creating a new one..."
          # ìƒˆë¡œìš´ deployment.yaml íŒŒì¼ ìƒì„±
          cat > "${MANIFEST_FILE}" << EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: wedding-invitation
          namespace: wedding-invitation
          labels:
            app: wedding-invitation
        spec:
          replicas: 2
          revisionHistoryLimit: 2
          selector:
            matchLabels:
              app: wedding-invitation
          template:
            metadata:
              labels:
                app: wedding-invitation
            spec:
              containers:
                - name: wedding-invitation
                  image: ${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}
                  ports:
                    - containerPort: 3000
        EOF
          echo "New deployment.yaml created"
        else
          echo "Existing deployment.yaml found"
        fi
        
        # í˜„ìž¬ ì´ë¯¸ì§€ íƒœê·¸ í™•ì¸ (ë””ë²„ê¹… ê°•í™”)
        echo "Current deployment.yaml content (image line):"
        grep -n "image:" "${MANIFEST_FILE}" || echo "âŒ No image line found"
        echo ""
        echo "Full deployment.yaml content for debugging:"
        cat "${MANIFEST_FILE}"
        
        # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ (ë” ì •í™•í•œ íŒ¨í„´ ë§¤ì¹­)
        echo "Updating image tag to: ${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}"
        sed -i "s|image: ${{ env.IMAGE_NAME }}:.*|image: ${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}|g" "${MANIFEST_FILE}"
        
        # ë³€ê²½ì‚¬í•­ í™•ì¸
        echo ""
        echo "âœ… Updated deployment.yaml (image line):"
        grep -n "image:" "${MANIFEST_FILE}"
        
        # ë³€ê²½ì‚¬í•­ì´ ìžˆëŠ”ì§€ í™•ì¸
        if git diff --exit-code --quiet "${MANIFEST_FILE}"; then
          echo "No changes to deployment.yaml. Skipping commit."
          echo "changes_made=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected in deployment.yaml. Committing..."
          echo "changes_made=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push changes to montstrap
      if: success() && steps.update-manifest.outputs.changes_made == 'true'
      run: |
        echo "--- Committing & Pushing Changes ---"
        cd montstrap
        
        # Git ì„¤ì • í™•ì¸
        echo "Setting up git configuration..."
        git config user.name "${{ github.actor }}"
        git config user.email "${{ github.actor }}@users.noreply.github.com"
        
        echo "Git configuration:"
        git config --list | grep user || echo "No user config found"
        
        # í˜„ìž¬ ìƒíƒœ í™•ì¸
        echo ""
        echo "Git status before add:"
        git status
        
        # ë³€ê²½ì‚¬í•­ ì¶”ê°€
        echo ""
        echo "Adding changes..."
        git add .
        
        echo "Git status after add:"
        git status
        
        # ì»¤ë°‹
        echo ""
        echo "Creating commit..."
        git commit -m "ðŸš€ Update wedding-invitation image tag to ${{ env.SHORT_SHA }}"
        
        # ë¦¬ëª¨íŠ¸ í™•ì¸
        echo ""
        echo "Remote repositories:"
        git remote -v
        
        # í‘¸ì‹œ
        echo ""
        echo "Pushing changes..."
        git push origin main || git push origin master || git push
        
        echo "âœ… Changes pushed successfully!"

    - name: Debug Token Information
      if: failure()
      run: |
        echo "--- Token Debugging Information ---"
        echo "âš ï¸  If you see authentication errors, check:"
        echo "1. PERSONAL_GITHUB_TOKEN secret is set in repository secrets"
        echo "2. Token has 'repo' scope for private repositories"  
        echo "3. Token has 'public_repo' scope for public repositories"
        echo "4. Token owner has push access to ${{ env.MONTSTRAP_REPO }}"
        echo ""
        
    - name: Update Summary
      if: always()
      run: |
        echo "### ðŸš€ Deployment Manifest Update Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.update-manifest.outputs.changes_made }}" == "true" ]; then
          echo "âœ… **Successfully updated** \`${{ env.MONTSTRAP_PATH }}\` with image tag \`${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}\`." >> $GITHUB_STEP_SUMMARY
          echo "The changes have been committed and pushed to \`${{ env.MONTSTRAP_REPO }}\`." >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ No changes were needed for \`${{ env.MONTSTRAP_PATH }}\`." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

  # ë°°í¬ ì¤€ë¹„ ì™„ë£Œ ì•Œë¦¼
  deploy-ready:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [build-and-push, update-manifests]
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy notification
      run: |
        echo "### ðŸŽ‰ Wedding Invitation - Deployment Ready" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The Docker image has been built and pushed to the registry, and the deployment manifest has been updated." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image Tag:** \`${{ env.IMAGE_NAME }}:latest\` (or \`${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}\`)" >> $GITHUB_STEP_SUMMARY
        echo "**Manifest Updated:** \`${{ env.MONTSTRAP_REPO }}/${{ env.MONTSTRAP_PATH }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

  # ì‹¤íŒ¨ ì•Œë¦¼
  failure-notification:
    if: failure()
    needs: [build-and-push, update-manifests]
    runs-on: ubuntu-latest
    steps:
      - name: Send Failure Notification
        run: |
          echo "### âŒ CI/CD Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Wedding Invitation CI/CD pipeline has failed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${GITHUB_SHA:0:8}\`" >> $GITHUB_STEP_SUMMARY
