name: Build and Push Docker Image (No Cache)

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  # Docker Hub
  IMAGE_NAME: montkim9/wedding-invitation

  # montstrap repo / path
  MONTSTRAP_REPO: idoyo7/montstrap
  MONTSTRAP_DIR: wedding-invitation/manifests
  MONTSTRAP_FILE: deployment.yaml

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      packages: write

    outputs:
      short_sha: ${{ steps.vars.outputs.short_sha }}
      # NOTE: image_tag output sometimes resolves empty in downstream jobs.
      # Derive it from short_sha to make it deterministic.
      image_tag: ${{ format('montkim9/wedding-invitation:{0}', steps.vars.outputs.short_sha) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract short SHA
        id: vars
        run: |
          set -euo pipefail

          SHORT_SHA="$(printf "%s" "${GITHUB_SHA}" | cut -c1-6)"
          if [ -z "${SHORT_SHA}" ]; then
            echo "❌ SHORT_SHA is empty (GITHUB_SHA='${GITHUB_SHA:-}')" >&2
            exit 1
          fi

          IMAGE_TAG="${{ env.IMAGE_NAME }}:${SHORT_SHA}"
          if [ -z "${IMAGE_TAG}" ]; then
            echo "❌ IMAGE_TAG is empty" >&2
            exit 1
          fi

          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "image_tag=${IMAGE_TAG}" >> "$GITHUB_OUTPUT"
          echo "✅ Computed SHORT_SHA=${SHORT_SHA}"
          echo "✅ Computed IMAGE_TAG=${IMAGE_TAG}"

      - name: Debug step outputs
        run: |
          echo "steps.vars.outputs.short_sha='${{ steps.vars.outputs.short_sha }}'"
          echo "steps.vars.outputs.image_tag='${{ steps.vars.outputs.image_tag }}'"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Push 되는 케이스 (push to main/master or workflow_dispatch 등)
      - name: Build and push Docker image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          # cache 끄고 싶으면 아래 두 줄 추가
          # no-cache: true
          # pull: true
          build-args: |
            NEXT_PUBLIC_NAVER_MAP_CLIENT_ID=${{ secrets.NEXT_PUBLIC_NAVER_MAP_CLIENT_ID }}
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}
            ${{ env.IMAGE_NAME }}:latest

      # PR은 push 없이 build만
      - name: Build Docker image (Pull Request)
        if: github.event_name == 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: false
          build-args: |
            NEXT_PUBLIC_NAVER_MAP_CLIENT_ID=test_key_for_pr
          tags: |
            ${{ env.IMAGE_NAME }}:pr-${{ github.event.pull_request.number }}
      - name: Build Summary
        if: always()
        run: |
          echo "### 📦 Wedding Invitation Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Ref:** \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**SHA:** \`${{ steps.vars.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** \`linux/amd64\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**Image Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
            echo "${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          else
            echo "${{ env.IMAGE_NAME }}:pr-${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY

  update-manifests:
    name: Update montstrap deployment manifest
    needs: build-and-push
    runs-on: ubuntu-latest

    # main/master push에서만 실행
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    permissions:
      contents: write

    env:
      SHORT_SHA: ${{ needs.build-and-push.outputs.short_sha }}
      # Don't rely on needs.*.outputs.image_tag (it may be empty); compute from SHORT_SHA.
      IMAGE_TAG: ${{ format('montkim9/wedding-invitation:{0}', needs.build-and-push.outputs.short_sha) }}

    steps:
      - name: Validate computed image tag (fail fast)
        run: |
          set -euo pipefail
          echo "SHORT_SHA='${SHORT_SHA}'"
          echo "IMAGE_TAG='${IMAGE_TAG}'"

          if [ -z "${IMAGE_TAG}" ]; then
            echo "❌ IMAGE_TAG is empty. Refusing to modify manifest." >&2
            exit 1
          fi

          case "${IMAGE_TAG}" in
            "${{ env.IMAGE_NAME }}:"*) ;;
            *)
              echo "❌ IMAGE_TAG does not match expected prefix '${{ env.IMAGE_NAME }}:'" >&2
              exit 1
              ;;
          esac

      - name: Checkout montstrap repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.MONTSTRAP_REPO }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: montstrap

      - name: Verify montstrap checkout
        run: |
          echo "--- Verifying montstrap repository checkout ---"
          echo "Repository: ${{ env.MONTSTRAP_REPO }}"
          echo "SHORT_SHA: ${SHORT_SHA}"
          echo "IMAGE_TAG: ${IMAGE_TAG}"
          echo ""
          ls -la montstrap/

      - name: Ensure manifest exists
        id: ensure
        run: |
          set -euo pipefail
          cd montstrap

          MANIFEST_DIR="${{ env.MONTSTRAP_DIR }}"
          MANIFEST_FILE="${MANIFEST_DIR}/${{ env.MONTSTRAP_FILE }}"

          mkdir -p "${MANIFEST_DIR}"

          if [ ! -f "${MANIFEST_FILE}" ]; then
            echo "Manifest not found. Creating: ${MANIFEST_FILE}"
            echo "apiVersion: apps/v1" > "${MANIFEST_FILE}"
            echo "kind: Deployment" >> "${MANIFEST_FILE}"
            echo "metadata:" >> "${MANIFEST_FILE}"
            echo "  name: wedding-invitation" >> "${MANIFEST_FILE}"
            echo "  namespace: wedding-invitation" >> "${MANIFEST_FILE}"
            echo "  labels:" >> "${MANIFEST_FILE}"
            echo "    app: wedding-invitation" >> "${MANIFEST_FILE}"
            echo "spec:" >> "${MANIFEST_FILE}"
            echo "  replicas: 2" >> "${MANIFEST_FILE}"
            echo "  revisionHistoryLimit: 2" >> "${MANIFEST_FILE}"
            echo "  selector:" >> "${MANIFEST_FILE}"
            echo "    matchLabels:" >> "${MANIFEST_FILE}"
            echo "      app: wedding-invitation" >> "${MANIFEST_FILE}"
            echo "  template:" >> "${MANIFEST_FILE}"
            echo "    metadata:" >> "${MANIFEST_FILE}"
            echo "      labels:" >> "${MANIFEST_FILE}"
            echo "        app: wedding-invitation" >> "${MANIFEST_FILE}"
            echo "    spec:" >> "${MANIFEST_FILE}"
            echo "      containers:" >> "${MANIFEST_FILE}"
            echo "        - name: wedding-invitation" >> "${MANIFEST_FILE}"
            echo "          image: ${IMAGE_TAG}" >> "${MANIFEST_FILE}"
            echo "          ports:" >> "${MANIFEST_FILE}"
            echo "            - containerPort: 3000" >> "${MANIFEST_FILE}"
          fi

          echo "manifest_file=${MANIFEST_FILE}" >> "$GITHUB_OUTPUT"
          echo "--- Current image lines ---"
          grep -n "image:" "${MANIFEST_FILE}" || true

      - name: Update image tag in manifest
        id: update
        run: |
          set -euo pipefail
          cd montstrap

          MANIFEST_FILE="${{ steps.ensure.outputs.manifest_file }}"

          echo "--- Before ---"
          grep -n "image:" "${MANIFEST_FILE}" || true

          if [ -z "${IMAGE_TAG}" ]; then
            echo "❌ IMAGE_TAG is empty. Refusing to run sed replacement." >&2
            exit 1
          fi

          # 공백/들여쓰기 포함해 image 라인을 안전하게 교체
          # 1) image: <IMAGE_NAME>:<anything> 형태가 있으면 교체
          if grep -Eq "^[[:space:]]*image:[[:space:]]*${{ env.IMAGE_NAME }}:" "${MANIFEST_FILE}"; then
            sed -i -E "s|(^[[:space:]]*image:[[:space:]]*)${{ env.IMAGE_NAME }}:.*|\\1${IMAGE_TAG}|g" "${MANIFEST_FILE}"
          else
            # 2) image: 라인이 아예 없거나 다른 이미지면, 첫 번째 컨테이너 블록 아래에 넣고 싶다면 로직 추가 가능
            #    여기서는 "image:" 라인이 있으면 그걸 교체(이미지명이 다르면 바꾸지 않음)하고,
            #    없으면 실패로 처리해서 눈에 띄게 함.
            echo "❌ No matching image line for ${{ env.IMAGE_NAME }} found in ${MANIFEST_FILE}"
            echo "Please ensure the manifest contains an image line for ${{ env.IMAGE_NAME }}."
            echo "--- Full manifest ---"
            cat "${MANIFEST_FILE}"
            exit 1
          fi

          echo "--- After ---"
          grep -n "image:" "${MANIFEST_FILE}" || true

          # 변경 여부 체크
          if git diff --exit-code --quiet "${MANIFEST_FILE}"; then
            echo "changes_made=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected."
          else
            echo "changes_made=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected."
          fi

      - name: Commit and push changes to montstrap
        if: steps.update.outputs.changes_made == 'true'
        run: |
          set -euo pipefail
          cd montstrap

          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          git status
          git add "${{ steps.ensure.outputs.manifest_file }}"
          git commit -m "🚀 Update wedding-invitation image tag to ${SHORT_SHA}"

          # main/master 어느 브랜치인지 자동으로 맞춰 푸시
          BRANCH="${GITHUB_REF_NAME}"
          echo "Pushing to branch: ${BRANCH}"
          git push origin "${BRANCH}"

      - name: Update Summary
        if: always()
        run: |
          echo "### 🚀 Deployment Manifest Update Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repo:** \`${{ env.MONTSTRAP_REPO }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**File:** \`${{ env.MONTSTRAP_DIR }}/${{ env.MONTSTRAP_FILE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.update.outputs.changes_made || 'false' }}" = "true" ]; then
            echo "✅ Updated and pushed successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ No changes were needed (or update step did not run)." >> $GITHUB_STEP_SUMMARY
          fi

  deploy-ready:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    needs: [build-and-push, update-manifests]
    runs-on: ubuntu-latest
    steps:
      - name: Deploy notification
        run: |
          SHORT_SHA="${{ needs.build-and-push.outputs.short_sha }}"
          IMAGE_TAG="${{ needs.build-and-push.outputs.image_tag }}"

          echo "### 🎉 Wedding Invitation - Deployment Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Docker image built/pushed and manifest updated." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${IMAGE_TAG}\` (and \`${{ env.IMAGE_NAME }}:latest\`)" >> $GITHUB_STEP_SUMMARY
          echo "**Manifest:** \`${{ env.MONTSTRAP_REPO }}/${{ env.MONTSTRAP_DIR }}/${{ env.MONTSTRAP_FILE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**SHA:** \`${SHORT_SHA}\`" >> $GITHUB_STEP_SUMMARY

  failure-notification:
    if: failure()
    needs: [build-and-push, update-manifests]
    runs-on: ubuntu-latest
    steps:
      - name: Send Failure Notification
        run: |
          echo "### ❌ CI/CD Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${GITHUB_SHA::8}\`" >> $GITHUB_STEP_SUMMARY
