name: Build and Push Docker Image (No Cache)

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©

env:
  # Docker Hub (ê¸°ë³¸ registry)
  IMAGE_NAME: montkim9/wedding-invitation
  # montstrap ë ˆí¬ì§€í† ë¦¬ ê²½ë¡œ
  MONTSTRAP_REPO: idoyo7/montstrap
  MONTSTRAP_PATH: montstrap/wedding-invitation/manifests/deployment.yaml

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: write # montstrap ë ˆí¬ì§€í† ë¦¬ì— í‘¸ì‹œí•˜ê¸° ìœ„í•´ í•„ìš”
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract short SHA
      id: vars
      run: echo "SHORT_SHA=${GITHUB_SHA:0:6}" >> $GITHUB_ENV

    - name: Log in to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      if: github.event_name != 'pull_request'
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        build-args: |
          NEXT_PUBLIC_NAVER_MAP_CLIENT_ID=${{ secrets.NEXT_PUBLIC_NAVER_MAP_CLIENT_ID }}
        tags: |
          ${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}
          ${{ env.IMAGE_NAME }}:latest
        
    - name: Build Docker image (Pull Request)
      if: github.event_name == 'pull_request'
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: false
        build-args: |
          NEXT_PUBLIC_NAVER_MAP_CLIENT_ID=test_key_for_pr

    - name: Build Summary
      if: always() # í•­ìƒ ì‹¤í–‰
      run: |
        echo "### ðŸ“¦ Wedding Invitation Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image Tags:**" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event_name }}" != "pull_request" ]; then
          echo "${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "${{ env.IMAGE_NAME }}:pr-${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Registry:** \`Docker Hub\`" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**SHA:** \`${{ env.SHORT_SHA }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Platform:** \`linux/amd64\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

  # montstrap ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  update-manifests:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Verify GitHub Token
      run: |
        echo "--- Verifying GitHub Token ---"
        if [ -z "${{ secrets.PERSONAL_GITHUB_TOKEN }}" ]; then
          echo "âŒ PERSONAL_GITHUB_TOKEN is not set!"
          exit 1
        fi
        echo "âœ… PERSONAL_GITHUB_TOKEN is set"
        
        # í† í°ìœ¼ë¡œ montstrap ì €ìž¥ì†Œ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
        echo "Testing access to ${{ env.MONTSTRAP_REPO }}..."
        RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.PERSONAL_GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ env.MONTSTRAP_REPO }}")
        
        if echo "$RESPONSE" | grep -q '"message": "Not Found"'; then
          echo "âŒ montstrap ì €ìž¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤!"
          echo "í™•ì¸ì‚¬í•­:"
          echo "1. ì €ìž¥ì†Œëª…: ${{ env.MONTSTRAP_REPO }}"
          echo "2. í† í° ì†Œìœ ìžê°€ í•´ë‹¹ ì €ìž¥ì†Œì— ì ‘ê·¼ ê¶Œí•œì´ ìžˆëŠ”ì§€"
          echo "3. í† í° ìŠ¤ì½”í”„ì— 'repo' (private) ë˜ëŠ” 'public_repo' (public)ê°€ í¬í•¨ë˜ì–´ ìžˆëŠ”ì§€"
          exit 1
        elif echo "$RESPONSE" | grep -q '"message": "Bad credentials"'; then
          echo "âŒ GitHub í† í°ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
          exit 1
        else
          echo "âœ… montstrap ì €ìž¥ì†Œ ì ‘ê·¼ ì„±ê³µ"
          echo "$RESPONSE" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    print(f'ì €ìž¥ì†Œ: {data[\"full_name\"]}')
    print(f'ê¸°ë³¸ ë¸Œëžœì¹˜: {data[\"default_branch\"]}')
    print(f'Private: {data[\"private\"]}')
except: pass
          "
        fi

    - name: Checkout montstrap repository
      uses: actions/checkout@v4
      with:
        repository: ${{ env.MONTSTRAP_REPO }}
        token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
        path: montstrap
        
    - name: Verify montstrap checkout and setup
      run: |
        echo "--- Verifying montstrap repository checkout ---"
        echo "Repository: ${{ env.MONTSTRAP_REPO }}"
        echo "Target manifest: ${{ env.MONTSTRAP_PATH }}"
        echo ""
        
        if [ ! -d "montstrap" ]; then
          echo "âŒ montstrap ë””ë ‰í† ë¦¬ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        echo "montstrap ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
        find montstrap -type f -name "*.yaml" -o -name "*.yml" | head -10 || echo "YAML íŒŒì¼ ì—†ìŒ"
        echo ""
        
        echo "wedding-invitation ë””ë ‰í† ë¦¬ í™•ì¸:"
        ls -la montstrap/wedding-invitation/ || echo "wedding-invitation ë””ë ‰í† ë¦¬ ì—†ìŒ (ìƒì„± ì˜ˆì •)"

    - name: Update deployment manifest
      id: update-manifest
      run: |
        echo "--- Updating Deployment Manifest ---"
        cd montstrap
        
        # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        MANIFEST_DIR="wedding-invitation/manifests"
        MANIFEST_FILE="${MANIFEST_DIR}/deployment.yaml"
        NEW_IMAGE_TAG="${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}"
        
        echo "ðŸŽ¯ Target manifest: ${MANIFEST_FILE}"
        echo "ðŸ·ï¸ New image tag: ${NEW_IMAGE_TAG}"
        echo ""
        
        # ë””ë ‰í† ë¦¬ ìƒì„±
        echo "ðŸ“ Creating directory structure..."
        mkdir -p "${MANIFEST_DIR}"
        echo "âœ… Directory created: ${MANIFEST_DIR}"
        
        # deployment.yaml íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸
        if [ ! -f "${MANIFEST_FILE}" ]; then
          echo "ðŸ“ Creating new deployment.yaml..."
          cat > "${MANIFEST_FILE}" << 'EOF'
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wedding-invitation
  namespace: wedding-invitation
  labels:
    app: wedding-invitation
spec:
  replicas: 2
  revisionHistoryLimit: 2
  selector:
    matchLabels:
      app: wedding-invitation
  template:
    metadata:
      labels:
        app: wedding-invitation
    spec:
      containers:
        - name: wedding-invitation
          image: PLACEHOLDER_IMAGE
          ports:
            - containerPort: 3000
          env:
            - name: NEXT_PUBLIC_NAVER_MAP_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: wedding-invitation-secrets
                  key: naver-map-client-id
EOF
          echo "âœ… New deployment.yaml created with placeholder"
        else
          echo "ðŸ“„ Existing deployment.yaml found"
        fi
        
        # í˜„ìž¬ ìƒíƒœ í™•ì¸
        echo ""
        echo "ðŸ“‹ Current deployment.yaml content:"
        echo "----------------------------------------"
        cat "${MANIFEST_FILE}"
        echo "----------------------------------------"
        
        # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ (ë” ê°•ë ¥í•œ íŒ¨í„´)
        echo ""
        echo "ðŸ”„ Updating image tag..."
        
        # 1ë‹¨ê³„: PLACEHOLDER_IMAGEë¥¼ ìƒˆ ì´ë¯¸ì§€ë¡œ êµì²´
        sed -i "s|PLACEHOLDER_IMAGE|${NEW_IMAGE_TAG}|g" "${MANIFEST_FILE}"
        
        # 2ë‹¨ê³„: ê¸°ì¡´ montkim9/wedding-invitation ì´ë¯¸ì§€ë¥¼ ìƒˆ íƒœê·¸ë¡œ êµì²´
        sed -i "s|image: montkim9/wedding-invitation:.*|image: ${NEW_IMAGE_TAG}|g" "${MANIFEST_FILE}"
        
        # 3ë‹¨ê³„: ì¼ë°˜ì ì¸ íŒ¨í„´ìœ¼ë¡œ êµì²´ (ì¶”ê°€ ì•ˆì „ìž¥ì¹˜)
        sed -i "s|image: .*montkim9/wedding-invitation.*|image: ${NEW_IMAGE_TAG}|g" "${MANIFEST_FILE}"
        
        echo "âœ… Image tag update completed"
        
        # ì—…ë°ì´íŠ¸ í›„ ìƒíƒœ í™•ì¸
        echo ""
        echo "ðŸ“‹ Updated deployment.yaml content:"
        echo "----------------------------------------"
        cat "${MANIFEST_FILE}"
        echo "----------------------------------------"
        
        # ì´ë¯¸ì§€ ë¼ì¸ í•˜ì´ë¼ì´íŠ¸
        echo ""
        echo "ðŸ·ï¸ Updated image line:"
        grep -n "image:" "${MANIFEST_FILE}" || echo "âŒ No image line found!"
        
        # Git ë³€ê²½ì‚¬í•­ í™•ì¸
        echo ""
        echo "ðŸ“ Git diff output:"
        git add "${MANIFEST_FILE}"
        git diff --cached "${MANIFEST_FILE}" || echo "No changes detected"
        
        # ë³€ê²½ì‚¬í•­ì´ ìžˆëŠ”ì§€ í™•ì¸ (ë” ì •í™•í•œ ë°©ë²•)
        if git diff --cached --quiet "${MANIFEST_FILE}"; then
          echo "âŒ No changes to deployment.yaml. This might indicate an update failure."
          echo "changes_made=false" >> $GITHUB_OUTPUT
          
          # ë””ë²„ê¹…ì„ ìœ„í•´ sed ê²°ê³¼ ìž¬í™•ì¸
          echo ""
          echo "ðŸ” Debugging sed results:"
          echo "Target pattern: montkim9/wedding-invitation:*"
          echo "Replacement: ${NEW_IMAGE_TAG}"
          grep -E "(montkim9/wedding-invitation|image:)" "${MANIFEST_FILE}" || echo "Pattern not found"
        else
          echo "âœ… Changes detected in deployment.yaml!"
          echo "changes_made=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push changes to montstrap
      if: success() && steps.update-manifest.outputs.changes_made == 'true'
      run: |
        echo "--- Committing & Pushing Changes ---"
        cd montstrap
        
        # Git ì„¤ì •
        echo "ðŸ”§ Setting up git configuration..."
        git config user.name "${{ github.actor }}"
        git config user.email "${{ github.actor }}@users.noreply.github.com"
        
        echo "ðŸ“ Git configuration:"
        git config --list | grep user
        
        # í˜„ìž¬ ë¸Œëžœì¹˜ í™•ì¸
        echo ""
        echo "ðŸŒ¿ Current branch info:"
        git branch -a
        echo "Current branch: $(git branch --show-current)"
        
        # ìƒíƒœ í™•ì¸
        echo ""
        echo "ðŸ“Š Git status:"
        git status --porcelain
        
        # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
        echo ""
        echo "ðŸ“‹ Changed files:"
        git diff --name-only HEAD
        
        # ì»¤ë°‹ ìƒì„±
        echo ""
        echo "ðŸ’¾ Creating commit..."
        COMMIT_MSG="ðŸš€ Update wedding-invitation image to ${{ env.SHORT_SHA }}

- Updated image: ${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}
- Triggered by commit: ${{ github.sha }}
- Author: ${{ github.actor }}
- Workflow: ${{ github.workflow }}"
        
        git commit -m "${COMMIT_MSG}"
        
        if [ $? -eq 0 ]; then
          echo "âœ… Commit created successfully"
        else
          echo "âŒ Commit creation failed"
          exit 1
        fi
        
        # ë¦¬ëª¨íŠ¸ ì •ë³´ í™•ì¸
        echo ""
        echo "ðŸŒ Remote repositories:"
        git remote -v
        
        # í‘¸ì‹œ ì‹œë„ (ì—¬ëŸ¬ ë¸Œëžœì¹˜ ì‹œë„)
        echo ""
        echo "ðŸš€ Pushing changes..."
        
        # í˜„ìž¬ ë¸Œëžœì¹˜ë¥¼ ë¨¼ì € ì‹œë„
        CURRENT_BRANCH=$(git branch --show-current)
        echo "Trying to push to origin/${CURRENT_BRANCH}..."
        
        if git push origin "${CURRENT_BRANCH}"; then
          echo "âœ… Successfully pushed to origin/${CURRENT_BRANCH}"
        elif git push origin main; then
          echo "âœ… Successfully pushed to origin/main"
        elif git push origin master; then
          echo "âœ… Successfully pushed to origin/master"  
        elif git push; then
          echo "âœ… Successfully pushed to default remote"
        else
          echo "âŒ All push attempts failed!"
          echo ""
          echo "ðŸ” Debug information:"
          echo "Remote URL: $(git remote get-url origin)"
          echo "Current branch: ${CURRENT_BRANCH}"
          echo "Available branches: $(git branch -r)"
          echo ""
          echo "Git push output:"
          git push origin "${CURRENT_BRANCH}" 2>&1 || true
          exit 1
        fi
        
        echo ""
        echo "ðŸŽ‰ Changes successfully pushed to montstrap repository!"
        
        # ìµœì¢… ê²€ì¦
        echo ""
        echo "ðŸ” Final verification:"
        echo "Latest commit: $(git log -1 --oneline)"
        echo "Current HEAD: $(git rev-parse HEAD)"

    - name: Debug Token and Repository Information
      if: failure()
      run: |
        echo "--- Debugging Information for Manifest Update Failure ---"
        echo ""
        echo "ðŸ” Repository Information:"
        echo "Source repo: ${{ github.repository }}"
        echo "Target repo: ${{ env.MONTSTRAP_REPO }}"
        echo "Target path: ${{ env.MONTSTRAP_PATH }}"
        echo "Actor: ${{ github.actor }}"
        echo ""
        
        echo "ðŸ”‘ Token Requirements:"
        echo "1. PERSONAL_GITHUB_TOKEN must be set in repository secrets"
        echo "2. Token must have 'repo' scope (for private repos) or 'public_repo' scope (for public repos)"
        echo "3. Token owner (${{ github.actor }}) must have WRITE access to ${{ env.MONTSTRAP_REPO }}"
        echo "4. Token must not be expired"
        echo ""
        
        echo "ðŸ“ Expected Directory Structure in montstrap repo:"
        echo "${{ env.MONTSTRAP_REPO }}"
        echo "â””â”€â”€ wedding-invitation/"
        echo "    â””â”€â”€ manifests/"
        echo "        â””â”€â”€ deployment.yaml"
        echo ""
        
        echo "ðŸ”§ To fix this issue:"
        echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
        echo "2. Check if PERSONAL_GITHUB_TOKEN is properly set"
        echo "3. Generate a new token at: https://github.com/settings/tokens"
        echo "4. Ensure token has correct scopes and hasn't expired"
        echo "5. Verify ${{ github.actor }} has push access to ${{ env.MONTSTRAP_REPO }}"
        echo ""
        
        if [ -d "montstrap" ]; then
          echo "ðŸ“‚ Montstrap directory exists, checking contents:"
          find montstrap -type f | head -20 || echo "No files found"
        else
          echo "âŒ Montstrap directory was not checked out - this indicates a token/permission issue"
        fi
        
    - name: Update Summary
      if: always()
      run: |
        echo "### ðŸš€ Deployment Manifest Update Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.update-manifest.outputs.changes_made }}" == "true" ]; then
          echo "âœ… **Successfully updated** \`${{ env.MONTSTRAP_PATH }}\` with image tag \`${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}\`." >> $GITHUB_STEP_SUMMARY
          echo "The changes have been committed and pushed to \`${{ env.MONTSTRAP_REPO }}\`." >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ No changes were needed for \`${{ env.MONTSTRAP_PATH }}\`." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

  # ë°°í¬ ì¤€ë¹„ ì™„ë£Œ ì•Œë¦¼
  deploy-ready:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [build-and-push, update-manifests]
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy notification
      run: |
        echo "### ðŸŽ‰ Wedding Invitation - Deployment Ready" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The Docker image has been built and pushed to the registry, and the deployment manifest has been updated." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image Tag:** \`${{ env.IMAGE_NAME }}:latest\` (or \`${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}\`)" >> $GITHUB_STEP_SUMMARY
        echo "**Manifest Updated:** \`${{ env.MONTSTRAP_REPO }}/${{ env.MONTSTRAP_PATH }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

  # ì‹¤íŒ¨ ì•Œë¦¼
  failure-notification:
    if: failure()
    needs: [build-and-push, update-manifests]
    runs-on: ubuntu-latest
    steps:
      - name: Send Failure Notification
        run: |
          echo "### âŒ CI/CD Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Wedding Invitation CI/CD pipeline has failed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${GITHUB_SHA:0:8}\`" >> $GITHUB_STEP_SUMMARY
